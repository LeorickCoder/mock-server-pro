# 路径处理逻辑重构

## 重构概述

本次重构主要针对 `MockDispatcher` 类中的路径处理逻辑进行了全面优化，解决了原有设计中存在的一些潜在问题，包括路径规范化不完整、挂载点识别不准确和路径处理不一致等。

## 主要改进

1. **新增路径处理工具模块**

   创建了 `src/utils/path-validator.ts` 模块，提供了一系列路径处理的工具函数：
   
   - `validatePath`: 验证路径是否合法
   - `normalizePath`: 规范化路径格式
   - `joinPaths`: 智能组合基础路径和相对路径
   - `stripQueryParams`: 去除URL中的查询参数
   - `isAbsolutePath`: 判断是否为绝对路径
   - `pathsMatch`: 比较两个路径是否匹配

2. **优化挂载点检测**

   改进了 `_detectMountingPoint` 方法（原 `_detectBasePath`），增强了挂载点的检测能力：
   
   - 优先使用 `req.baseUrl` 检测挂载点
   - 提供了备用的检测机制，通过比较 `originalUrl` 和 `path` 的差异
   - 对检测到的挂载点进行规范化处理

3. **强化路径计算逻辑**

   重写了 `_computeRequestPath` 方法（原 `_processRequestPath`）：
   
   - 支持完整的请求路径计算，考虑 `baseUrl` 和 `path`
   - 正确处理查询参数
   - 根据不同的挂载模式智能处理路径

4. **规范化路径格式**

   实现了更加健壮的路径规范化逻辑：
   
   - 处理前导斜杠和尾部斜杠
   - 移除连续的重复斜杠
   - 保持路径格式的一致性

5. **修复前缀处理问题**

   优化了前缀处理逻辑：
   
   - 正确处理路径组合
   - 避免前缀重复
   - 支持相对路径和绝对路径的混合使用

6. **增强API接口**

   扩展了 `ModuleContext` 接口：
   
   - 添加了常用HTTP方法的便捷调用方式（`get`, `post`, `put` 等）
   - 添加了中间件注册的简便方法 (`use`)
   - 完善了文档注释

## 测试与验证

为了验证重构的有效性，我们添加了：

1. **单元测试**：创建了 `src/tests/dispatcher.test.ts` 文件，包含多个针对不同路径处理场景的测试用例

2. **集成测试**：添加了 `dev-project/src/mocks/path-test.ts` 模块，测试不同格式的路径注册和处理

## 工作原理

重构后的路径处理机制工作流程如下：

1. **路由注册阶段**：
   - 验证路径的合法性
   - 规范化路径格式
   - 根据配置模式处理前缀
   - 创建路由映射

2. **请求处理阶段**：
   - 检测挂载点
   - 计算实际请求路径
   - 根据挂载模式调整路径处理策略
   - 匹配注册的路由处理器

3. **响应生成阶段**：
   - 记录请求处理信息
   - 应用匹配的中间件或路由处理器
   - 处理完成后清理请求记录

## 不同挂载模式的处理策略

1. **Append 模式**：
   - 适用于 `app.use(middleware)` 的场景
   - 路由注册时可以使用带前缀的完整路径或不带前缀的相对路径
   - 处理请求时使用完整路径匹配路由

2. **Mount 模式**：
   - 适用于 `app.use('/prefix', middleware)` 的场景
   - 路由注册时使用不带前缀的相对路径
   - 处理请求时自动补充前缀以匹配路由

3. **Auto 模式**：
   - 自动检测挂载方式并采用适当的策略
   - 可以动态适应不同的挂载环境
   - 推荐使用相对路径注册路由，最大程度保持灵活性

## 未来改进方向

1. **缓存机制**：对频繁访问的路径计算结果进行缓存

2. **路径参数提取**：提供工具函数方便提取和处理路径参数

3. **通配符支持**：增加对通配符路径的支持

4. **性能优化**：进一步优化路径匹配算法的性能 